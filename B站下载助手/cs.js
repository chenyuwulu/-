(async()=>{const e=()=>"www.bilibili.com"===location.hostname||"bilibili.com"===location.hostname;if(!e())return;const n=()=>/\/video\/av\d+/i.test(window.location.pathname),t=()=>/\/bangumi\/play\/\S+/i.test(window.location.pathname);if(!n()&&!t())return;const i={credentials:"include"},o=()=>Promise.resolve({code:-1,message:"获取下载地址失败，可能是临时性的网络问题，如多次重试仍然报错，请通过邮箱或者QQ群反馈给我，谢谢"}),a=e=>e.durl?{code:0,durls:e.durl.map(e=>{const n=new URL(e.url);return n.protocol=window.location.protocol,{url:n.href,size:e.size}}),qualityDescription:l[e.quality]}:-10403===e.code?(e.message="该视频只能登陆大会员账号之后下载",e):void 0!==e.code?e:{code:-2,message:"该视频暂时不支持下载，请通过邮箱或者QQ群反馈给我，谢谢"},l={112:"高清1080P+",80:"高清1080P",74:"高清720P60",64:"高清720P",32:"清晰480P",16:"流畅360P"},s=()=>"normal"!==localStorage.bilibili_helper_download_mode,d=()=>"off"!==localStorage.bilibili_helper_merge_mode,r=()=>"hide"===localStorage.bilibili_helper_show,c=e=>{const n=1073741824,t=1048576;return e>=n?`${(e/n).toFixed(2)}GB`:e>=t?`${(e/t).toFixed(2)}MB`:e>=1024?`${(e/1024).toFixed(2)}KB`:e+"B"},p=(e,n)=>`<strong>${e}</strong> 的下载地址(共${n}个分段)：`,g=(e,n)=>{if(!s())return e.map((e,t)=>`\n        <li><a title="${n}_分段${t+1}" download href="${e.url}">分段${t+1}</a><span class="size">(${c(e.size)})</span></li>\n      `).join("");if(s()&&!d())return e.map((e,t)=>{const i=encodeURIComponent(JSON.stringify(e));return`\n          <li><a title="${n}_分段${t+1}" mode="advanced" merge="off" href="#nogo" durl="${i}">分段${t+1}</a><span class="size">(${c(e.size)})</span><span durl="${i}" class="progress"></span></li>\n        `}).join("");if(s()&&d()){const t=encodeURIComponent(JSON.stringify(e));let i=0;return e.forEach(e=>i+=e.size),`<li><a title="${n}" durls="${t}" mode="advanced" merge="on" href="#nogo">合并下载</a><span class="size">(共${c(i)})</span><ul style="margin-top: 8px;" durls="${t}" class="progress"></ul></li>`}},h=e=>chrome.runtime.getURL(e),m=({code:e,title:n,durls:t,message:i})=>{let o=document.getElementById("bilibili-helper-host"),a=null;o?((a=o.shadowRoot).getElementById("title").innerHTML=p(n,t.length),a.getElementById("durls").innerHTML=g(t,n)):((o=document.createElement("bilibili-helper-host")).id="bilibili-helper-host",o.style.cssText=`display:block;overflow:auto;position:fixed;z-index:${Number.MAX_SAFE_INTEGER};bottom:0;left:0;right:0;max-height:50%;width:100%;background: #fff;border-top: 1px solid #ccc;box-shadow: rgba(0, 0, 0, 0.2) 0 -5px 10px;`,r()?o.classList.add("hide"):o.classList.remove("hide"),o.innerHTML="<style>\n        #bilibili-helper-host.hide{\n          width:auto!important;\n          left:auto!important;\n          background:transparent!important;\n          border:0 none!important;\n          border-radius: 6px 0 0 0;\n          box-shadow: rgba(0, 0, 0, 0.2) -5px -5px 10px!important;\n        }\n        .player-fullscreen-fix #bilibili-helper-host {\n          z-index: -1!important;\n        }\n      </style>",document.body.appendChild(o),(a=o.attachShadow({mode:"open"})).innerHTML=`\n        <style>\n          p, a, div, span, li, i, b, strong, input, button, label {\n            font-size: inherit;\n          }\n          li {\n            margin-bottom: 5px;\n          }\n          p {\n            margin: 0;\n            line-height: 1.5;\n          }\n          h1 {\n            font-size: 20px;\n            font-weight: bold;\n            margin-bottom: 20px;\n          }\n          h3 {\n            font-size: 16px;\n            margin: 1em 0;\n          }\n          #title {\n            font-size: 16px;\n            font-weight: normal;\n          }\n          #content {\n            display: flex;\n            width: 100%;\n            font-size: 14px;\n            position: relative;\n          }\n          a {\n            color: #00a1d6 !important;\n            text-decoration: none;\n          }\n          a:hover {\n            text-decoration: underline;\n          }\n          a.disabled {\n            color: #666!important;\n          }\n          a.disabled:hover {\n            text-decoration: none;\n            cursor: not-allowed;\n          }\n          #side-bar {\n            flex: 3;\n            padding: 20px;\n            border-right: 1px solid #ccc;\n            margin-right: -1px;\n          }\n          #main {\n            flex: 7;\n            padding: 20px;\n            border-left: 1px solid #ccc;\n          }\n          #notice-frame {\n            width: 100%;\n            padding: 0;\n          }\n          .donate {\n            border-top: 1px solid #ccc;\n            padding-top: 10px;\n          }\n          #zanshang {\n            width: 80%;\n          }\n          .setting-item {\n            margin-bottom: 8px;\n          }\n          .setting-item .label {\n            font-weight: bold;\n            width: 6em;\n            display: inline-block;\n            text-align: right;\n          }\n          .desc {\n            padding-left: 6em;\n          }\n          #actions {\n            position: absolute;\n            right: 0;\n            top: 0;\n          }\n          .btn-large {\n            border: 0 none;\n            background: #f45a8d;\n            border-radius: 6px;\n            color: #fff;\n            padding: 10px 20px;\n          }\n          #toggle {\n            border-radius: 0 0 0 6px;\n            outline: none;\n            cursor: pointer;\n          }\n          .hide #side-bar {\n            display: none;\n          }\n          .hide #main {\n            display: none;\n          }\n          .hide #toggle {\n            border-radius: 6px 0 0 0;\n          }\n          .hide #actions {\n            position: static;\n          }\n      \n          a.btn {\n            border: 0 none;\n            background: #f45a8d;\n            text-decoration: none !important;\n            color: #fff !important;\n            border-radius: 3px;\n            padding: 5px 10px;\n            display: inline-block;\n          }\n          .settings {\n            border-left: 5px solid #ccc;\n            background: #eee;\n            padding: 16px 16px 8px 0;\n          }\n          .size {\n            margin: 0 5px;\n          }\n        </style>\n        <div id="content" ${r()?'class="hide"':""}>\n          <div id="side-bar">\n            <div class="notice">\n              <iframe id="notice-frame" frameborder="0"></iframe>\n            </div>\n            \x3c!--<div class="support">TODO 支持区域</div>--\x3e\n            <div class="donate">\n              <p>微信扫一扫赞赏作者(扫不出来请点击图片后扫大图)：</p>\n              <a href="${h("zanshang.png")}" target="_blank"><img title="点击查看大图" alt="点击查看大图" id="zanshang" src="${h("zanshang.png")}"/></a>\n            </div>\n          </div>\n          <div id="main">\n            <h1 style="margin-top: 0;">B站下载助手</h1>\n            <div class="settings">\n              <div class="setting-item">\n                <span class="label">清晰度：</span>\n                <span>请在页面中B站自己的播放器内切换清晰度</span>\n              </div>\n              <div class="setting-item">\n                <span class="label">下载模式：</span>\n                <label><input id="setting-download-mode-advanced" checked name="setting-download-mode" type="radio"/> 高级</label>\n                <label><input id="setting-download-mode-normal" name="setting-download-mode" type="radio"/> 兼容</label>\n                <p class="desc">高级模式支持自动重命名和合并下载，但会占用非常大的系统运行内存<br/>兼容模式直接使用浏览器的默认下载，资源占用很小，但不支持自动重命名和合并下载</p>\n                <p class="desc">建议系统运行内存小于16G的用户使用兼容模式，下载后可以点<a href="http://csser.top/bilibili/merge.html" target="_blank">这里</a>尝试手动合并</p>\n              </div>\n              <div class="setting-item" id="setting-advanced">\n                <span class="label">合并下载：</span>\n                <label><input id="setting-merge-on" checked name="setting-merge" type="radio"> 开</label>\n                <label><input id="setting-merge-off" name="setting-merge" type="radio"> 关</label>\n                <p class="desc">高级模式下载过程中请<strong style="color: red;">不要</strong>刷新或关闭页面，也<strong style="color: red;">不要</strong>切换分集和清晰度</p>\n              </div>\n            </div>\n            <h3 id="title">${p(n,t.length)}</h3>\n            <ul id="durls">\n              ${g(t,n)}\n            </ul>\n            <div class="beg">\n              <p>\n                如果这个工具确实帮到了您，烦请在Chrome商店给个五星好评，谢谢😊\n                <a class="btn" href="https://chrome.google.com/webstore/detail/bfcbfobhcjbkilcbehlnlchiinokiijp/reviews" target="_blank">去评价</a>\n              </p>\n            </div>\n          </div>\n          <div id="actions">\n            <button id="toggle" class="btn-large">${r()?"打开B站下载助手":"收起"}</button>\n          </div>\n        </div>\n      `,(e=>{const n=e.getElementById("setting-download-mode-advanced"),t=e.getElementById("setting-download-mode-normal"),i=e.getElementById("setting-merge-on"),o=e.getElementById("setting-merge-off"),a=e.getElementById("setting-advanced"),l=e.getElementById("durls"),c=e.getElementById("toggle"),p=e.getElementById("actions"),g=e.getElementById("content"),h=document.getElementById("bilibili-helper-host"),m=()=>{n.disabled=!0,t.disabled=!0,i.disabled=!0,o.disabled=!0},b=()=>{n.disabled=!1,t.disabled=!1,i.disabled=!1,o.disabled=!1};s()?(n.checked=!0,t.checked=!1,a.style.display="block"):(n.checked=!1,t.checked=!0,a.style.display="none"),d()?(i.checked=!0,o.checked=!1):(i.checked=!1,o.checked=!0);const u=()=>{e.buildDownloadLinks()};n.addEventListener("change",()=>{n.checked?(localStorage.bilibili_helper_download_mode="advanced",a.style.display="block"):(localStorage.bilibili_helper_download_mode="normal",a.style.display="none"),u()}),t.addEventListener("change",()=>{t.checked?(localStorage.bilibili_helper_download_mode="normal",a.style.display="none"):(localStorage.bilibili_helper_download_mode="advanced",a.style.display="block"),u()}),i.addEventListener("change",()=>{localStorage.bilibili_helper_merge_mode=i.checked?"on":"off",u()}),o.addEventListener("change",()=>{localStorage.bilibili_helper_merge_mode=o.checked?"off":"on",u()}),l.addEventListener("click",n=>{const t=n.target;if("a"===t.tagName.toLowerCase()&&"advanced"===t.getAttribute("mode")){if(n.preventDefault(),n.stopPropagation(),t.classList.contains("disabled"))return;let i=null;const o=t.getAttribute("title");"on"===t.getAttribute("merge")?(i=e.querySelector(`ul[durls="${t.getAttribute("durls")}"]`),m(),y(t,JSON.parse(decodeURIComponent(t.getAttribute("durls"))),o,i).then(b)):(i=e.querySelector(`span[durl="${t.getAttribute("durl")}"]`),m(),f(t,JSON.parse(decodeURIComponent(t.getAttribute("durl"))),o,i).then(b))}}),c.addEventListener("click",()=>{r()?(localStorage.bilibili_helper_show="show",g.classList.remove("hide"),c.innerHTML="收起",h.classList.remove("hide"),p.style.top="0",e.getElementById("notice-frame").contentWindow.postMessage({action:"getHeight"},"https://csser.top")):(localStorage.bilibili_helper_show="hide",g.classList.add("hide"),h.classList.add("hide"),c.innerHTML="打开B站下载助手",p.style.top="0")}),h.addEventListener("scroll",()=>{p.style.top=h.scrollTop+"px"})})(a),(e=>{const n=e.getElementById("notice-frame");n.onload=(()=>{n.contentWindow.postMessage({action:"getHeight"},"https://csser.top");const e=chrome.runtime.getManifest();n.contentWindow.postMessage({action:"setVersion",version:{name:e.version,code:parseInt(e.version.replace(/\./g,""),10)}},"https://csser.top"),n.contentWindow.postMessage({action:"setTheme",theme:"null"},"https://csser.top")}),window.addEventListener("message",e=>{if("https://csser.top"===e.origin&&e.data&&"reportHeight"===e.data.action&&(n.style.height=e.data.height+10+"px"),"https://csser.top"===e.origin&&e.data&&"showBilibilihelperindooorsmanNoticeDialog"===e.data.action){const n=e.data.notices;n&&n.length>0&&n.forEach(e=>{console.log("notice:",e)})}}),n.src=`https://csser.top/bilibili/notice.html?t=${Date.now()}`,window.addEventListener("resize",()=>{n.contentWindow.postMessage({action:"getHeight"},"https://csser.top")})})(a)),a.buildDownloadLinks=(()=>{a.getElementById("durls").innerHTML=g(t,n)})},b=(e,n)=>{const t=new Blob([e],{type:"application/octet-stream"}),i=document.createElement("a");i.setAttribute("href",URL.createObjectURL(t)),i.setAttribute("download",n),i.setAttribute("style","position:absolute;top:-9999px;"),document.body.appendChild(i);const o=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window});i.dispatchEvent(o),setTimeout(()=>{document.body.removeChild(i)},1e3)},u=(e,n,t)=>{let o=null;return fetch(e,i).then(e=>{const i=e.headers.get("content-length"),a=n||parseInt(i,10);let l=0;return o=setInterval(()=>{t(l,a)},1e3),new Response(new ReadableStream({start(n){const t=e.body.getReader(),i=()=>{t.read().then(({done:e,value:t})=>{e?n.close():(l+=t.byteLength,n.enqueue(t),i())}).catch(e=>{n.error(e)})};i()}}))}).then(e=>e.blob()).finally(()=>{o&&clearInterval(o)})},f=(e,{url:n,size:t},i,o)=>(e.classList.add("disabled"),u(n,t,(e,n)=>{const t=Math.ceil(e/n*100);o.innerHTML=` 正在下载 ${e}/${n} - ${t}%`}).then(e=>{o.innerHTML=" 已下载完成";const t=new URL(n).pathname.toLowerCase().match(/\.[a-z0-9]+?$/)[0];b(e,i+t)}).finally(()=>{e.classList.remove("disabled")})),y=(e,n,t,i)=>{if(1===n.length)return f(e,n[0],t,i);e.classList.add("disabled");const o=n.map(({url:e,size:n},t)=>{const o=document.createElement("li");return o.innerHTML=`分段${t+1} (${c(n)}) 正在下载`,i.appendChild(o),u(e,n,(e,i)=>{const a=Math.ceil(e/i*100);o.innerHTML=`分段${t+1} (${c(n)}) 正在下载 ${e}/${i} - ${a}%`}).then(e=>(o.innerHTML=`分段${t+1} (${c(n)}) 已下载完成，等待合并`,e))});return Promise.all(o).then(async e=>{const n=await FLV.mergeBlobs(Array.from(e));b(n,t+".flv"),i.innerHTML="已完成"}).finally(()=>{e.classList.remove("disabled")})},v=async()=>{if(!e())return;const l=await(()=>fetch(window.location.href,i).then(e=>e.text()).then(e=>{const n=e.match(/<script>window.__INITIAL_STATE__=(.+?)<\/script>/);return n&&n[1]?JSON.parse(n[1].replace(";(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());","")):{code:-2,message:"获取视频信息失败，请通过邮箱或QQ群反馈给我，谢谢"}}).catch(o))();console.log("initial state:",l);let s=localStorage.bilibili_player_settings&&+JSON.parse(localStorage.bilibili_player_settings).setting_config.defquality||112;if(n()){const e=l.videoData.aid;let n,t,d=l.videoData.cid;if(l.videoData.pages.length>1){const e=location.search.match(/p=(\d+)/);let i=l.videoData.pages[0];e&&e[1]&&(i=l.videoData.pages.find(n=>""+n.page==""+e[1])),n=i.page,t=i.part,d=i.cid}const{code:r,durls:c,qualityDescription:p,message:g}=await((e,n,t=112)=>{return fetch(`//api.bilibili.com/x/player/playurl?cid=${n}&avid=${e}&otype=json&qn=${t}`,i).then(e=>e.json()).then(e=>0!==e.code?a(e):a(e.data)).catch(o)})(e,d,s);if(0===r){let e=`[${p}] ${l.videoData.title}`;n&&t&&(e=`[${p}] ${l.videoData.title}_P${n}_${t}`),m({code:r,title:e,durls:c,message:g})}}if(t()){const e=l.epList;let n=-1===l.epId?e[e.length-1].ep_id:l.epId,t=e.find(e=>n===e.ep_id);const d=await(e=>new Promise(n=>{let t=0,i=setInterval(()=>{t++;const o=document.querySelector(e);(o||t>10)&&(clearInterval(i),i=null,n(o))},500)}))(".episode-item.on");if(d){const i=d.querySelector(".ep-title").textContent.trim();t=e.find(e=>i===e.index_title),n=t.ep_id}const{code:r,durls:c,qualityDescription:p,message:g}=await((e,n=112)=>{return fetch(`//api.bilibili.com/pgc/player/web/playurl/?ep_id=${e}&qn=${n}&bsource=`,i).then(e=>e.json()).then(e=>0!==e.code?a(e):a(e.result)).catch(o)})(n,s);if(0===r){const e=`[${p}] ${l.mediaInfo.title}_${t.index}_${t.index_title}`;m({code:r,title:e,durls:c,message:g})}}};v();let w=""+window.location.href,x=""+localStorage.bilibili_player_settings;setInterval(()=>{const e=window.location.href,n=localStorage.bilibili_player_settings;w!==e&&(w=e,v()),x!==n&&(x=n,v())},1e3)})();